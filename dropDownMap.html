<!DOCTYPE html>
<html>
<head>
<title>AtJ</title>
<meta charset="utf-8" />
<link rel="stylesheet" href="leaflet.css" />
<script src="leaflet.js"></script>
<script src="dropdown.js"></script>
<script type="text/javascript" src="County_Centroids.js"></script>
<style>#map { width: 70%; height: 650px;}
</style>
</head>

<body>
<div id="map"></div>

<script type="text/javascript">
////////////////////////////////////////////////////////////////////////////////////////////
//setting up the map//
////////////////////////////////////////////////////////////////////////////////////////////

var map = new L.Map('map').setView([33, -84], 7);

L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
	maxZoom: 11,
    minZoom: 7,
  attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);


////////////////////////////////////////////////////////////////////////////////////////////
//adding the data//
////////////////////////////////////////////////////////////////////////////////////////////

//var noIcon = L.icon({
//    iconUrl: 'leaf-green.png',
//	iconSize:[10,10], // size of the icon
//});

//var markerLayer = L.geoJson(stations, {
// onEachFeature: function(feature, layer) {
//    layer.bindPopup(feature.properties.STATION + " County");
//  }}).addTo(map);


var markerLayer = L.geoJson(stations, {
           pointToLayer: function(feature, latlng) {
                var smallIcon = new L.Icon({
					iconSize: [1, 1],
					iconUrl: 'leaf-green.png'
				});
                return L.marker(latlng, {icon: smallIcon});
            },
           onEachFeature: function (feature, layer) {
                   layer.bindPopup(feature.properties.STATION + " County");
           }
         }).addTo(map);

map.fitBounds(markerLayer.getBounds());


////////////////////////////////////////////////////////////////////////////////////////////
//creating the selector control//
////////////////////////////////////////////////////////////////////////////////////////////

//create Leaflet control for selector
var selector = L.control({
  position: 'topright'
});

selector.onAdd = function(map) {
  //create div container
  var div = L.DomUtil.create('div', 'mySelector');
  //create select element within container (with id, so it can be populated later)
  div.innerHTML = '<select id="marker_select"><option value="init">(select station)</option></select>';
  return div;
};

selector.addTo(map);


//have to use eachFeature (instead of onEachFeature) to create selector options
//because _leaflet_id doesn't exist until after each feature is created
markerLayer.eachLayer(function(layer) {
  //create option in selector element
  //with content set to city name
  //and value set to the layer's internal ID
  var optionElement = document.createElement("option");
  optionElement.innerHTML = layer.feature.properties.STATION;
  optionElement.value = layer._leaflet_id;
  L.DomUtil.get("marker_select").appendChild(optionElement);
});



////////////////////////////////////////////////////////////////////////////////////////////
//setting up event listeners//
////////////////////////////////////////////////////////////////////////////////////////////

var marker_select = L.DomUtil.get("marker_select");

//prevent clicks on the selector from propagating through to the map
//(otherwise popups will close immediately after opening)
L.DomEvent.addListener(marker_select, 'click', function(e) {
  L.DomEvent.stopPropagation(e);
});

L.DomEvent.addListener(marker_select, 'change', changeHandler);

function changeHandler(e) {
  if (e.target.value == "init") {
    map.closePopup();
  } else {
    markerLayer.getLayer(e.target.value).openPopup();
  }
}

</script>
</body>
